name: Deploy to EC2

on:
  push:
    branches: [ "main", "dev" ]
    paths:
      - 'AIApp/**'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.event.pusher.name == 'KazuhiraBenedictMiller'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          path: AlfredoAI

      - name: Build Docker image and Push to Docker Hub
        run: |
          docker build -f AlfredoAI/AIApp/Docker/InferenceAPI.Dockerfile -t kazuhirabenedictmiller/alfredoaiapp:latest AlfredoAI/AIApp
          docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} -p ${{ secrets.DOCKER_HUB_PASSWORD }}
          docker push kazuhirabenedictmiller/alfredoaiapp:latest
          docker logout
          sudo rm -rf /home/admin/.docker/config.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Write SSH key to file
        run: |
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy to EC2 via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem admin@${{ secrets.EC2_IP_ADDRESS }} "
            export ACTUAL_API_KEY=$(aws ssm get-parameter --name "ACTUAL_API_KEY" --with-decryption --query "Parameter.Value" --output text)
            docker pull kazuhirabenedictmiller/alfredoaiapp:latest;
            docker stop AIInference || true;
            docker rm AIInference || true;
            docker run -d -it -p 8000:8000 -e ACTUAL_API_KEY="$ACTUAL_API_KEY" --name AIInference kazuhirabenedictmiller/alfredoaiapp:latest;
            docker image prune -a -f;
          "